{% extends "base.html" %}
{% block title %}Панель управления{% endblock %}

{% block content %}
<div class="row">
    <!-- Левая колонка: Обучение и список моделей -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header"><h4><i class="fa-solid fa-plus me-2"></i>Обучить новую модель</h4></div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="interface-select" class="form-label">1. Сетевой интерфейс:</label>
                    <select id="interface-select" class="form-select">
                        <option selected disabled>Выберите...</option>
                        {% for iface in interfaces %}
                            <option value="{{ iface }}">{{ iface }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="duration-input" class="form-label">2. Время обучения (мин):</label>
                    <input type="number" class="form-control" id="duration-input" value="2" min="1">
                </div>
                <div class="mb-3">
                    <label for="model-name-input" class="form-label">3. Имя новой модели:</label>
                    <input type="text" class="form-control" id="model-name-input" placeholder="Например, 'Домашняя сеть'">
                </div>
                <!-- Выпадающий список для выбора типа модели -->
                <div class="mb-3">
                    <label for="model-type-select" class="form-label">4. Тип модели:</label>
                    <select id="model-type-select" class="form-select">
                        <option value="isolation_forest" selected>Isolation Forest (Быстрый)</option>
                        <option value="tensorflow">TensorFlow (Точный)</option>
                    </select>
                </div>
                <div class="d-grid">
                    <button type="button" class="btn btn-success" id="start-training-btn">
                        <i class="fa-solid fa-play me-2"></i>Начать обучение
                    </button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h4><i class="fa-solid fa-list-check me-2"></i>Ваши обученные модели</h4></div>
            <div class="card-body" id="models-list-container">
                {% if models %}
                    <ul class="list-group list-group-flush">
                        {% for model in models %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" id="model-item-{{ model.id }}">
                                <div>
                                    <strong>{{ model.name }}</strong><br>
                                    <!-- Отображаем тип модели -->
                                    <small class="text-muted">Тип: {{ model.model_type }} | Обучена: {{ model.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-info btn-sm rename-btn" data-model-id="{{ model.id }}" data-current-name="{{ model.name }}" title="Переименовать"><i class="fa-solid fa-pencil"></i></button>
                                    <button class="btn btn-primary btn-sm activate-btn" data-model-id="{{ model.id }}" title="Активировать"><i class="fa-solid fa-power-off"></i></button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-model-id="{{ model.id }}" title="Удалить"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-muted">У вас пока нет обученных моделей.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Правая колонка: Статус и мониторинг -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fa-solid fa-chart-line me-2"></i>Статус и Мониторинг</h4>
                <button type="button" class="btn btn-danger" id="stop-session-btn" disabled>
                    <i class="fa-solid fa-stop me-2"></i>Остановить
                </button>
            </div>
            <div class="card-body">
                <div id="status-display" class="alert alert-secondary text-center">
                    <strong>Состояние:</strong> <span id="status-mode">Ожидание...</span> | <strong>Интерфейс:</strong> <span id="status-interface">N/A</span>
                </div>
                <canvas id="scoreChart"></canvas>
                <hr>
                <h5>Журнал сессии:</h5>
                <div id="log-box" class="form-control" style="height: 250px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap; background-color: #212529;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для переименования -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Переименовать модель</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control" id="modal-new-name-input">
                <input type="hidden" id="modal-model-id-input">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="modal-save-btn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Обертка, чтобы скрипт запускался только после полной загрузки страницы
document.addEventListener('DOMContentLoaded', function() {

    // --- Инициализация элементов ---
    const startTrainingBtn = document.getElementById('start-training-btn');
    const stopSessionBtn = document.getElementById('stop-session-btn');
    const modelsListContainer = document.getElementById('models-list-container');
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    let wasRunning = false;

    // --- Инициализация графика ---
    const ctx = document.getElementById('scoreChart').getContext('2d');
    const scoreChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Anomaly Score',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                pointRadius: 3,
                pointBackgroundColor: [] // Будем заполнять динамически
            }, {
                label: 'Адаптивный Порог',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                borderDash: [5, 5],
                tension: 0.1,
                pointRadius: 0
            }]
        },
        options: {
            animation: { duration: 500 },
            scales: { y: { beginAtZero: false } }
        }
    });

    // --- Обработчики событий ---

    // Кнопка "Начать обучение"
    startTrainingBtn.addEventListener('click', function() {
        const interfaceVal = document.getElementById('interface-select').value;
        const modelName = document.getElementById('model-name-input').value.trim();
        const duration = document.getElementById('duration-input').value;
        const modelType = document.getElementById('model-type-select').value;

        if (!interfaceVal || interfaceVal.includes('...')) {
            alert('Пожалуйста, выберите сетевой интерфейс.');
            return;
        }
        if (!modelName) {
            alert('Пожалуйста, введите имя для новой модели.');
            return;
        }
        if (!duration || parseInt(duration) < 1) {
            alert('Время обучения должно быть не меньше 1 минуты.');
            return;
        }

        fetch("{{ url_for('start_training') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                interface: interfaceVal,
                model_name: modelName,
                training_duration: duration,
                model_type: modelType
            })
        });
    });

    // Кнопка "Остановить"
    stopSessionBtn.addEventListener('click', function() {
        if (confirm('Вы уверены, что хотите прервать текущую операцию?')) {
            fetch("{{ url_for('stop_session') }}", { method: 'POST' });
        }
    });

    // Кнопка "Сохранить" в модальном окне
    document.getElementById('modal-save-btn').addEventListener('click', function() {
        const modelId = document.getElementById('modal-model-id-input').value;
        const newName = document.getElementById('modal-new-name-input').value.trim();

        if (newName) {
            fetch("{{ url_for('rename_model') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_id: modelId, new_name: newName })
            }).then(response => {
                if (response.ok) {
                    renameModal.hide();
                    window.location.reload(); // Перезагружаем для обновления списка
                }
            });
        }
    });

    // Обработка кликов на кнопках моделей (удалить, переименовать, активировать)
    modelsListContainer.addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (!button) return;

        const modelId = button.dataset.modelId;

        // Удалить
        if (button.classList.contains('delete-btn')) {
            if (confirm('Вы уверены, что хотите удалить эту модель?')) {
                fetch("{{ url_for('delete_model') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: modelId })
                }).then(response => {
                    if (response.ok) window.location.reload();
                });
            }
        }
        // Переименовать
        else if (button.classList.contains('rename-btn')) {
            document.getElementById('modal-new-name-input').value = button.dataset.currentName;
            document.getElementById('modal-model-id-input').value = modelId;
            renameModal.show();
        }
        // Активировать
        else if (button.classList.contains('activate-btn')) {
            const interfaceVal = document.getElementById('interface-select').value;
            if (!interfaceVal || interfaceVal.includes('...')) {
                alert('Пожалуйста, выберите сетевой интерфейс для мониторинга.');
                return;
            }
            fetch("{{ url_for('activate_model') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_id: modelId, interface: interfaceVal })
            });
        }
    });


    // --- Функции для обновления интерфейса ---

    function updateChart(status) {
        const MAX_POINTS = 30;
        const labels = scoreChart.data.labels;
        const scores = scoreChart.data.datasets[0].data;
        const thresholds = scoreChart.data.datasets[1].data;
        const colors = scoreChart.data.datasets[0].pointBackgroundColor;

        // В зависимости от типа модели, название может меняться
        scoreChart.data.datasets[0].label = status.mode.includes('tensorflow') ? 'Ошибка восстановления' : 'Anomaly Score';

        labels.push(new Date().toLocaleTimeString());
        scores.push(status.current_score);
        thresholds.push(status.adaptive_threshold);
        colors.push(status.is_anomaly ? 'rgb(255, 99, 132)' : 'rgb(75, 192, 192)');

        if (labels.length > MAX_POINTS) {
            labels.shift();
            scores.shift();
            thresholds.shift();
            colors.shift();
        }
        scoreChart.update();
    }

    function updateStatus() {
        fetch("{{ url_for('status') }}")
            .then(response => response.json())
            .then(status => {
                // Обновляем текст статуса
                document.getElementById('status-mode').textContent = status.mode;
                document.getElementById('status-interface').textContent = status.interface || 'N/A';

                // Обновляем лог-бокс
                const logBox = document.getElementById('log-box');
                const newLogHtml = status.log.map(line => {
                    if (line.includes('[DANGER]')) return `<span class="log-line-danger">${line}</span>`;
                    if (line.includes('[SUCCESS]')) return `<span class="log-line-success">${line}</span>`;
                    if (line.includes('[WARNING]')) return `<span class="log-line-warning">${line}</span>`;
                    return `<span class="log-line-info">${line}</span>`;
                }).join('\n');

                if (logBox.innerHTML !== newLogHtml) {
                    logBox.innerHTML = newLogHtml;
                }

                // Включаем/выключаем кнопки
                const isRunning = status.is_running;
                startTrainingBtn.disabled = isRunning;
                stopSessionBtn.disabled = !isRunning;
                document.querySelectorAll('.activate-btn, .rename-btn, .delete-btn').forEach(btn => btn.disabled = isRunning);

                // Если сессия только что завершилась, перезагружаем страницу, чтобы обновить список моделей
                if (!isRunning && wasRunning) {
                    wasRunning = false;
                    window.location.reload();
                }
                if (isRunning) {
                    wasRunning = true;
                }

                // Подсвечиваем активную модель
                const currentActiveItem = document.querySelector('.list-group-item.active');
                if (currentActiveItem) currentActiveItem.classList.remove('active');
                if (status.mode.includes('Мониторинг') && status.model_id) {
                    const newActiveItem = document.getElementById(`model-item-${status.model_id}`);
                    if (newActiveItem) newActiveItem.classList.add('active');
                }

                // Обновляем график или очищаем его
                if (status.mode.includes('Мониторинг')) {
                    updateChart(status);
                } else {
                    scoreChart.data.labels = [];
                    scoreChart.data.datasets.forEach(dataset => dataset.data = []);
                    scoreChart.data.datasets[0].pointBackgroundColor = [];
                    scoreChart.update();
                }
            });
    }

    // --- Запуск периодического обновления ---
    setInterval(updateStatus, 2000); // Обновлять каждые 2 секунды
    updateStatus(); // Первоначальный вызов
});
</script>
{% endblock %}

