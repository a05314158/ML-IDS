{% extends "base.html" %}
{% block title %}Панель ML{% endblock %}

{% block content %}
<div class="row">
    <!-- Левая колонка: Создание и список моделей -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header"><h4><i class="fa-solid fa-plus me-2"></i>Создать новую модель</h4></div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="model-name-input" class="form-label">1. Имя новой модели:</label>
                    <input type="text" class="form-control" id="model-name-input" placeholder="Например, 'Основная модель TF'">
                </div>
                <div class="mb-3">
                    <label for="model-type-select" class="form-label">2. Тип модели:</label>
                    <select id="model-type-select" class="form-select">
                        <option value="isolation_forest" selected>Isolation Forest (Быстрый)</option>
                        <option value="tensorflow">TensorFlow (Точный)</option>
                    </select>
                </div>
                <div class="d-grid">
                    <button type="button" class="btn btn-success" id="create-model-btn">
                        <i class="fa-solid fa-play me-2"></i>Создать и обучить
                    </button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h4><i class="fa-solid fa-list-check me-2"></i>Ваши модели</h4></div>
            <div class="card-body" id="models-list-container">
                {% if models %}
                    <ul class="list-group list-group-flush">
                        {% for model in models %}
                            <li class="list-group-item d-flex justify-content-between align-items-center {% if model.is_active %}active{% endif %}" id="model-item-{{ model.id }}">
                                <div>
                                    <strong>{{ model.name }}</strong><br>
                                    {% if model.model_path %}
                                    <small class="text-muted">Тип: {{ model.model_type }} | Обучена: {{ model.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% else %}
                                    <small class="text-warning">Ожидает обучения...</small>
                                    {% endif %}
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm activate-btn" data-model-id="{{ model.id }}" title="Активировать" {% if not model.model_path %}disabled{% endif %}><i class="fa-solid fa-power-off"></i></button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-model-id="{{ model.id }}" title="Удалить"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-muted">У вас пока нет моделей.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Правая колонка: Статус и мониторинг -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fa-solid fa-chart-line me-2"></i>Статус и Мониторинг</h4>
                <div class="d-flex align-items-center">
                    <label for="interface-select" class="form-label me-2 mb-0">Интерфейс:</label>
                    <select id="interface-select" class="form-select form-select-sm" style="width: auto;">
                        {% for iface in interfaces %}
                            <option value="{{ iface }}" {% if active_state.interface == iface %}selected{% endif %}>{{ iface }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-danger btn-sm ms-3" id="stop-monitoring-btn"><i class="fa-solid fa-stop me-2"></i>Остановить</button>
                </div>
            </div>
            <div class="card-body">
                <div id="status-display" class="alert alert-secondary text-center">
                    <strong>Состояние:</strong> <span id="status-mode">Ожидание...</span> | <strong>Интерфейс:</strong> <span id="status-interface">N/A</span>
                </div>
                <canvas id="scoreChart"></canvas>
                <hr>
                <h5>Журнал сессии:</h5>
                <div id="log-box" class="form-control" style="height: 250px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap; background-color: #212529;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    const createModelBtn = document.getElementById('create-model-btn');
    const stopMonitoringBtn = document.getElementById('stop-monitoring-btn');
    const modelsListContainer = document.getElementById('models-list-container');
    const chartCtx = document.getElementById('scoreChart').getContext('2d');

    const scoreChart = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Anomaly Score', data: [], borderColor: 'rgb(75, 192, 192)',
                tension: 0.1, pointRadius: 3, pointBackgroundColor: []
            }, {
                label: 'Адаптивный Порог', data: [], borderColor: 'rgb(255, 99, 132)',
                borderDash: [5, 5], tension: 0.1, pointRadius: 0
            }]
        },
        options: { animation: { duration: 500 }, scales: { y: { beginAtZero: false } } }
    });

    createModelBtn.addEventListener('click', function() {
        const modelName = document.getElementById('model-name-input').value.trim();
        const modelType = document.getElementById('model-type-select').value;
        if (!modelName) { alert('Введите имя модели'); return; }
        fetch("{{ url_for('create_model') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model_name: modelName, model_type: modelType })
        }).then(response => { if (response.ok) setTimeout(() => window.location.reload(), 1000); });
    });

    stopMonitoringBtn.addEventListener('click', function() {
        if (confirm('Вы уверены, что хотите остановить ML-мониторинг? Сбор статистики продолжится.')) {
            fetch("{{ url_for('stop_monitoring') }}", { method: 'POST' });
        }
    });

    modelsListContainer.addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (!button) return;
        const modelId = button.dataset.modelId;

        if (button.classList.contains('delete-btn')) {
            if (confirm('Вы уверены, что хотите удалить эту модель?')) {
                fetch("{{ url_for('delete_model') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: modelId })
                }).then(response => { if (response.ok) window.location.reload(); });
            }
        } else if (button.classList.contains('activate-btn')) {
            const interfaceVal = document.getElementById('interface-select').value;
            if (!interfaceVal) { alert('Интерфейс не выбран.'); return; }
            fetch("{{ url_for('activate_model') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_id: modelId, interface: interfaceVal })
            });
        }
    });

    function updateChart(status) {
        const MAX_POINTS = 30;
        const labels = scoreChart.data.labels;
        const scores = scoreChart.data.datasets[0].data;
        const thresholds = scoreChart.data.datasets[1].data;
        const colors = scoreChart.data.datasets[0].pointBackgroundColor;
        scoreChart.data.datasets[0].label = status.mode.includes('tensorflow') ? 'Ошибка восстановления' : 'Anomaly Score';
        labels.push(new Date().toLocaleTimeString());
        scores.push(status.current_score);
        thresholds.push(status.adaptive_threshold);
        colors.push(status.is_anomaly ? 'rgb(255, 99, 132)' : 'rgb(75, 192, 192)');
        if (labels.length > MAX_POINTS) {
            labels.shift(); scores.shift(); thresholds.shift(); colors.shift();
        }
        scoreChart.update();
    }

    function updateStatus() {
        fetch("{{ url_for('status') }}")
            .then(response => response.json())
            .then(status => {
                if (!status) return;
                document.getElementById('status-mode').textContent = status.mode || 'N/A';
                document.getElementById('status-interface').textContent = status.interface || 'N/A';

                const logBox = document.getElementById('log-box');
                const newLogHtml = (status.log || []).map(line => {
                    if (line.includes('[DANGER]')) return `<span class="log-line-danger">${line}</span>`;
                    if (line.includes('[SUCCESS]')) return `<span class="log-line-success">${line}</span>`;
                    if (line.includes('[WARNING]')) return `<span class="log-line-warning">${line}</span>`;
                    return `<span class="log-line-info">${line}</span>`;
                }).join('\n');
                if (logBox.innerHTML !== newLogHtml) { logBox.innerHTML = newLogHtml; }

                const isMonitoring = (status.mode || '').includes('Мониторинг');
                stopMonitoringBtn.disabled = !isMonitoring;

                if (isMonitoring) {
                    updateChart(status);
                } else {
                    scoreChart.data.labels = [];
                    scoreChart.data.datasets.forEach(dataset => { dataset.data = []; });
                    scoreChart.data.datasets[0].pointBackgroundColor = [];
                    scoreChart.update();
                }
            });
    }

    setInterval(updateStatus, 2000);
    updateStatus();
});
</script>
{% endblock %}

